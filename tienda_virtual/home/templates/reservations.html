<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reservar masaje Â· NATURSUR</title>
<style>
:root{
    --card:#8dacad;
    --bg:#11454a;
    --accent:#000000;
    --accent-2:#ffc802;
    --accent-3:#ffc802;
    --muted:#ffffff;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}

*{box-sizing:border-box;}

body{
    margin:0;
    background:var(--bg);
    color:#111;
}

header {
                padding:20px 32px;
                display:flex;
                align-items:center;
                justify-content:space-between;
                background:transparent;
}
.brand {
    display: flex;
    align-items: center;
    gap: 12px;
}
.logo {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent-2), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #111;
}
nav a {
    margin-right: 12px;
    color: #666;
    text-decoration: none;
}
nav a:last-child {
    margin-right: 0;
}

.container{max-width:900px;margin:36px auto;padding:20px;}

.card{
    background:var(--card);
    padding:20px;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
}

h1{margin:0 0 12px;color:var(--accent);}
p.lead{color:var(--muted);margin:0 0 18px;}

form{display:grid;gap:12px;}
label{font-weight:600;color:#222;}
input[type="text"], select{padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);}

.btn{background:linear-gradient(90deg,var(--accent-3),#90cbc9bf);color:white;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;}
.btn.secondary{background:transparent;border:2px solid var(--accent-2);color:#111;}

.message{padding:12px;border-radius:8px;background:linear-gradient(90deg,#eaffea,#f0fff0);border:1px solid #cde7cd;color:#083b08;margin-top:12px;}

.success-card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-top: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-left: 4px solid #10b981;
}

.success-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.success-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #10b981, #059669);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

.success-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: #111;
  margin: 0;
}

.reservation-details {
  background: #f9fafb;
  border-radius: 8px;
  padding: 16px;
  margin: 16px 0;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #e5e7eb;
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-label {
  color: #6b7280;
  font-weight: 600;
}

.detail-value {
  color: #111;
  font-weight: 500;
}

.calendar-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #4285F4, #1a73e8);
  color: white;
  padding: 12px 24px;
  text-decoration: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
  margin-top: 16px;
}

.calendar-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
}

.calendar-btn:active {
  transform: translateY(0);
}

/* Calendario */
.calendar{width:100%;text-align:center;margin-top:6px;}
.calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.calendar-grid .weekday{font-weight:700;padding:6px 0;}
.day{padding:10px 0;border-radius:8px;cursor:pointer;background:#fff;border:1px solid rgba(0,0,0,0.05);}
.day.disabled{color:#aaa;cursor:not-allowed;background:#f6f6f6;}
.day.full{background:#ffcccc;}
.day.partial{background:#ffe6b3;}
.day.selected{border:2px solid var(--accent);font-weight:bold;}

.slots{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;justify-content:center;}
.slot{padding:6px 10px;border-radius:6px;border:1px solid rgba(0,0,0,0.1);cursor:pointer;background:#fff;}
.slot.booked{background:#eee;color:#999;cursor:not-allowed;}
.slot.selected{background:linear-gradient(90deg,var(--accent),#90cbc9bf);color:white;}
</style>
</head>
<body>
<header style="background:#171717; padding: 16px 24px;">
  <div class="brand">
    <div class="name">
      <div style="font-weight: 800; font-size: 1.75rem; color: rgb(255, 255, 255); line-height: 1; display: flex; align-items: center">NATURSUR</div>
    </div>
  </div>
  <nav>
      <a href="{% url 'home' %}" style="margin-right:12px;color:#e5e5e5;text-decoration:none">Inicio</a>
      <a href="{% url 'catalog' %}" style="margin-right:12px;color:#e5e5e5;text-decoration:none">CatÃ¡logo</a>
      <a href="{% url 'reservations' %}" style="margin-right:12px;color:#e5e5e5;text-decoration:none">Masajes</a>
      <a href="{% url 'contact' %}" style="color:#e5e5e5;text-decoration:none">Contacto</a>
  </nav>
</header>

<div class="container">
  <div class="card">
    <h1>Reservar un masaje</h1>
    <p class="lead">Elige dÃ­a, hora y el tipo de masaje. Las reservas son por 60 minutos por defecto.</p>

    <form id="bookingForm">
      {% csrf_token %}
      <label for="name">Nombre</label>
      <input id="name" name="name" type="text" placeholder="Tu nombre" required />

      <label>Selecciona una fecha</label>
      <div class="calendar" id="calendar"></div>

      <div id="slotsContainer" style="display:none;">
        <label>Selecciona hora</label>
        <div class="slots" id="slots"></div>
      </div>

      <label for="service">Servicio</label>
      <select id="service" name="service">
        <option>Masaje relajante (60 min)</option>
        <option>Masaje deportivo (60 min)</option>
        <option>Masaje terapÃ©utico (60 min)</option>
      </select>

      <div style="display:flex;gap:12px;margin-top:8px">
        <button type="submit" class="btn">Reservar</button>
        <button type="reset" class="btn secondary">Limpiar</button>
      </div>
    </form>

    <div id="mensaje" class="message" style="display:none;">Â¡Reserva registrada localmente!</div>
  </div>
</div>

<script>
const calendarEl = document.getElementById("calendar");
const slotsContainer = document.getElementById("slotsContainer");
const slotsEl = document.getElementById("slots");
const mensajeEl = document.getElementById("mensaje");

let selectedDate = null;
let selectedSlot = null;

const allSlots = ["09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"];
let reservas = {};

// Festivos de ejemplo
const holidays = [""];

let currentMonth = new Date();

// Load reservations from database
async function loadReservations() {
  try {
    const response = await fetch('/api/reservations/');
    reservas = await response.json();
    renderCalendar(currentMonth);
  } catch(error) {
    console.error('Error loading reservations:', error);
    reservas = {};
    renderCalendar(currentMonth);
  }
}

// Initialize
loadReservations();

function renderCalendar(date){
  const year = date.getFullYear();
  const month = date.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month+1, 0);
  const today = new Date();

  calendarEl.innerHTML="";

  const header = document.createElement("div");
  header.className="calendar-header";
  const title = document.createElement("div");
  title.textContent=date.toLocaleString("es-ES",{month:"long", year:"numeric"});

  const prevBtn=document.createElement("button");
  prevBtn.textContent="â†";
  prevBtn.className="btn secondary";
  prevBtn.style.padding="4px 10px";
  prevBtn.onclick=()=>{
    const firstOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(),1);
    const prevMonth = new Date(year, month-1,1);
    if(prevMonth >= firstOfCurrentMonth){
      currentMonth=prevMonth;
      renderCalendar(currentMonth);
    }
  };

  const nextBtn=document.createElement("button");
  nextBtn.textContent="â†’";
  nextBtn.className="btn secondary";
  nextBtn.style.padding="4px 10px";
  nextBtn.onclick=()=>{
    currentMonth=new Date(year, month+1,1);
    renderCalendar(currentMonth);
  };

  header.appendChild(prevBtn);
  header.appendChild(title);
  header.appendChild(nextBtn);
  calendarEl.appendChild(header);

  // Grid
  const grid=document.createElement("div");
  grid.className="calendar-grid";

  // Cabecera dÃ­as de la semana
  const weekdays=["Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b","Dom"];
  weekdays.forEach(w=>{
    const wd=document.createElement("div");
    wd.className="weekday";
    wd.textContent=w;
    grid.appendChild(wd);
  });

  // Relleno de dÃ­as vacÃ­os
  const startWeekday=(firstDay.getDay()+6)%7;
  for(let i=0;i<startWeekday;i++){
    const empty=document.createElement("div");
    grid.appendChild(empty);
  }

  // DÃ­as del mes
  for(let d=1; d<=lastDay.getDate(); d++){
    const dayEl=document.createElement("div");
    dayEl.className="day";
    dayEl.textContent=d;
    const dateStr=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dayDate=new Date(year,month,d);
    const isWeekend=dayDate.getDay()==0 || dayDate.getDay()==6;
    const isHoliday=holidays.includes(dateStr);

    if(dayDate < new Date(today.getFullYear(),today.getMonth(),today.getDate()) || isWeekend || isHoliday){
      dayEl.classList.add("disabled");
    } else {
      const booked = reservas[dateStr] || [];
      if(booked.length === allSlots.length) dayEl.classList.add("full");
      else if(booked.length > 0) dayEl.classList.add("partial");
      dayEl.onclick=()=>selectDate(dateStr, dayEl);
    }

    grid.appendChild(dayEl);
  }

  calendarEl.appendChild(grid);
}

function selectDate(dateStr, el){
  document.querySelectorAll(".day").forEach(d=>d.classList.remove("selected"));
  el.classList.add("selected");
  selectedDate=dateStr;
  renderSlots(dateStr);
}

function renderSlots(dateStr){
  slotsContainer.style.display="block";
  slotsEl.innerHTML="";
  const booked=reservas[dateStr]||[];
  allSlots.forEach(s=>{
    const slot=document.createElement("div");
    slot.className="slot";
    slot.textContent=s;
    if(booked.includes(s)) slot.classList.add("booked");
    else{
      slot.onclick=()=>{
        document.querySelectorAll(".slot").forEach(sl=>sl.classList.remove("selected"));
        slot.classList.add("selected");
        selectedSlot=s;
      };
    }
    slotsEl.appendChild(slot);
  });
}

document.getElementById("bookingForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(!selectedDate || !selectedSlot){alert("Selecciona fecha y hora."); return;}
  
  const nombre=document.getElementById("name").value;
  const servicio=document.getElementById("service").value;
  
  const formData = new FormData();
  formData.append('name', nombre);
  formData.append('fecha', selectedDate);
  formData.append('hora', selectedSlot);
  formData.append('service', servicio);
  
  try {
    const response = await fetch('/reservations/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    const data = await response.json();
    console.log('Response data:', data); // Debug log
    
    if(data.success) {
      // Update local reservations without reloading page
      if(!reservas[selectedDate]) reservas[selectedDate] = [];
      reservas[selectedDate].push(selectedSlot);
      
      // Store date before resetting
      const currentSelectedDate = selectedDate;
      
      // Reset form and selections
      selectedDate=null; 
      selectedSlot=null;
      document.getElementById("bookingForm").reset();
      slotsContainer.style.display="none";
      
      // Re-render calendar to show updated availability
      renderCalendar(currentMonth);
      
      // Display message AFTER calendar re-render (important!)
      setTimeout(() => {
        mensajeEl.innerHTML = `
          <div class="success-card">
            <div class="success-header">
              <div class="success-icon">âœ“</div>
              <h3 class="success-title">Â¡Reserva Confirmada!</h3>
            </div>
            <p style="color: #6b7280; margin: 0 0 16px 0;">
              Tu cita ha sido registrada exitosamente. No olvides aÃ±adirla a tu calendario.
            </p>
            <div class="reservation-details">
              <div class="detail-row">
                <span class="detail-label">ðŸ“… Fecha:</span>
                <span class="detail-value">${new Date(currentSelectedDate).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">ðŸ•’ Hora:</span>
                <span class="detail-value">${reservas[currentSelectedDate][reservas[currentSelectedDate].length - 1]}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">ðŸ’† Servicio:</span>
                <span class="detail-value">${servicio}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">ðŸ‘¤ Nombre:</span>
                <span class="detail-value">${nombre}</span>
              </div>
            </div>
            ${data.calendarUrl ? `
              <a href="${data.calendarUrl}" target="_blank" class="calendar-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                AÃ±adir a Google Calendar
              </a>
            ` : ''}
          </div>
        `;
        mensajeEl.style.display="block";
        
        // Scroll to message
        mensajeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
      
    } else {
      alert('Error: ' + data.message);
    }
  } catch(error) {
    console.error('Error details:', error); // Debug log
    alert('Error al crear la reserva: ' + error);
  }
});

document.getElementById("bookingForm").addEventListener("reset",()=>{
  selectedDate=null; selectedSlot=null;
  slotsContainer.style.display="none";
  mensajeEl.style.display="none";
  document.querySelectorAll(".day").forEach(d=>d.classList.remove("selected"));
});

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
</body>
</html>
