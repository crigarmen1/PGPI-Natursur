{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página de Inicio - Bienestar y Cuidado</title>
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Carga de la biblioteca de iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="{% static 'home/styleIndex.css' %}" />
    
</head>
<body>

    <header>
        <nav class="container-max-width container-padding nav-main">
            
           <!-- Logo como texto -->
            <div class="logo-container">
                <a href="{% url 'home' %}" class="logo-text">
                    NATURSUR
                </a>
            </div>
            
            <!-- Enlaces de Navegación (actualizados a text-xl) -->
            <div class="nav-links">
                <a href="{% url 'home' %}" class="nav-link">Inicio</a>
                <a href="{% url 'catalog' %}" class="nav-link">Catálogo</a>
                <a href="{% url 'reservations' %}" class="nav-link">Masajes</a>
                <a href="{% url 'contact' %}" class="nav-link">Contacto</a>
            </div>

    </header>

    <main>
        <!-- 
          SECCIÓN HERO (HÉROE)
        -->
        <section class="hero-section">
            
            <!-- 2. Fondo de Imagen (Capa inferior) -->
            <div class="hero-bg-image">
                <img src="{% static 'home/images/massage.jpg' %}" alt="Fondo de masaje" class="">
            </div>

            <!-- 3. Superposición de Color (Capa intermedia) -->
            <!-- 'bg-teal-tint' es una clase personalizada, así que se mantiene -->
            <div class="hero-overlay bg-teal-tint"></div>

            <!-- 
              4. Contenido (Capa superior)
            -->
            <div class="container-max-width container-padding hero-content">
                <!-- Texto del Hero -->
                <div class="hero-text">
                    <h1 class="">
                        Bienestar y Cuidado a tu Alcance
                    </h1>
                    <p class="" style="color: #e6e6e6;">
                        Descubre nuestra selección exclusiva de productos y agenda tu próximo momento de bienestar con nosotros.
                    </p>
                    <div class="hero-buttons">
                        <!-- 'bg-primary-accent' es una clase personalizada, se mantiene -->
                        <a href="{% url 'reservations' %}" class="btn btn-primary" style="color: #000000;">
                            Reservar Cita
                        </a>
                        <a href="{% url 'catalog' %}" class="btn btn-secondary" style="color: #000000;">
                            Ver Catálogo
                        </a>
                    </div>
                </div>
               
            </div>
        </section>

        <!-- 
          --- MODIFICADO ---
          1. Se añade una <section> exterior con el fondo suave.
          2. El .featured-carousel es ahora un <div> interior con max-width.
        -->
        <section class="carousel-section-wrapper">

            <div class="container-max-width container-padding section-header"> 
                <h2 class="section-title">Descubre nuestros productos</h2>
                <a href="{% url 'catalog' %}" class="btn-link" style="color:  #ffc802">
                    <span>Ver catálogo completo</span>
                    <i data-lucide="arrow-right" class="btn-link-icon"></i>
                </a>
            </div>

            <div class="featured-carousel">
                <div class="carousel" id="carousel">
                    <div class="carousel-track" id="track">
                        {% for item in articulos %}
                        <div class="carousel-item">
                            {% if item.image_url %}
                                <img src="{{ item.image_url }}" alt="{{ item.nombre }}">
                            {% else %}
                                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='260'><rect fill='%23260b0b' width='100%' height='100%'/><text x='50%' y='50%' fill='%23ffd400' font-size='20' font-family='Arial' dominant-baseline='middle' text-anchor='middle'>{{ item.nombre }}</text></svg>" alt="{{ item.nombre }}">
                            {% endif %}
                            <div class="overlay">
                                <h3>{{ item.nombre }}</h3>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>

        </section>

        <section class="social-follow-section">
            <div class="container-max-width container-padding social-follow-content">
                
                <div class="social-image-wrapper">
                    <img src="{% static 'home/images/12001035.jpg' %}" alt="Imagen de perfil" class="social-image-circular">
                </div>

                <div class="social-text-wrapper">
                    <h2 class="section-title">Conecta con Nosotros</h2>
                    <p class="section-subtitle" style="max-width: 100%;"> Mantente al día con nuestras novedades, consejos y promociones exclusivas siguiéndonos en nuestras redes sociales.
                    </p>
                    
                    <div class="social-icons-list">
                        <a href="https://www.instagram.com/yosoyescalona" class="social-icon-link" aria-label="Instagram" target="_blank" rel="noopener noreferrer">
                            <i data-lucide="instagram"></i>
                        </a>
                        
                        <a href="https://www.youtube.com/@natursur" class="social-icon-link" aria-label="Youtube" target="_blank" rel="noopener noreferrer">
                            <i data-lucide="youtube"></i>
                        </a>
                        
                        <a href="https://www.facebook.com/natursur" class="social-icon-link" aria-label="Facebook" target="_blank" rel="noopener noreferrer">
                            <i data-lucide="facebook"></i>
                        </a>
                    </div>
                </div>

            </div>
        </section>
        </main>



    </main>

    <footer>
        <div class="container-max-width container-padding footer-content">
            <p>&copy; {% now "Y" %} Jalec. Todos los derechos reservados.</p>
        
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Reemplazo de Iconos Lucide ---
            lucide.createIcons();

            // --- Funcionalidad del Menú Móvil ---
            const menuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            if (menuButton && mobileMenu) {
                menuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }

        });
        
        // --- Script del Carrusel (Sin cambios) ---
        (function(){
                const track = document.getElementById('track');
                if(!track) return;
                let items = Array.from(track.children);
                let index = 0;
                let visible = 3;
                let itemWidth = 200;
                let currentTranslate = 0;
                const gap = 12; // matches CSS gap

                function recalc(){
                    items = Array.from(track.children);
                    // compute item width (include gap)
                    const first = items[0];
                    if(first){
                        const w = first.getBoundingClientRect().width;
                        itemWidth = Math.round(w + gap);
                    }
                    // compute visible count based on container width
                    const containerWidth = track.parentElement.clientWidth;
                    visible = Math.max(1, Math.floor(containerWidth / (itemWidth)) );
                }

                // track real (non-cloned) item count and clones per side
                let realCount = 0;
                let clonesPerSide = 0;

                function maxIndex(){
                    // total children - visible (used only for bounds if needed)
                    return Math.max(0, track.children.length - visible);
                }

                function cloneItems(){
                    // Determine current real items (non-clones)
                    const currentChildren = Array.from(track.children);
                    const realItems = currentChildren.filter(c => !c.hasAttribute('data-clone'));
                    realCount = realItems.length;
                    if(realCount === 0) return;

                    // Clear any existing clones first
                    currentChildren.forEach(c => { if(c.hasAttribute('data-clone')) c.remove(); });

                    // Clone all real items to each side for simpler wrap logic
                    clonesPerSide = realCount;
                    // append clones to right
                    for(let i = 0; i < realCount; i++){
                        const clone = realItems[i].cloneNode(true);
                        clone.setAttribute('data-clone', 'true');
                        track.appendChild(clone);
                    }
                    // prepend clones to left (reverse order)
                    for(let i = realCount - 1; i >= 0; i--){
                        const clone = realItems[i].cloneNode(true);
                        clone.setAttribute('data-clone', 'true');
                        track.insertBefore(clone, track.firstChild);
                    }
                }

                function update(animate = true){
                    recalc();

                    // If clones are not present, set them up and position to the middle block
                    if(!track.querySelector('[data-clone]')) {
                        cloneItems();
                        // Start at the first real item (after left clones)
                        index = clonesPerSide;
                        currentTranslate = -(itemWidth * index);
                        track.style.transition = 'none';
                        track.style.transform = `translateX(${currentTranslate}px)`;
                        // Force reflow
                        track.offsetHeight;
                    }

                    // Update transform with animation if needed
                    track.style.transition = animate ? 'transform 400ms ease' : 'none';
                    currentTranslate = -(itemWidth * index);
                    track.style.transform = `translateX(${currentTranslate}px)`;

                    // After animation, correct for wrap-around by moving index into the central real block
                    if(animate){
                        const total = track.children.length; // should be 3 * realCount
                        setTimeout(()=>{
                            if(realCount > 0){
                                if(index >= clonesPerSide + realCount){
                                    // moved into right clones, shift back by realCount
                                    index = index - realCount;
                                    track.style.transition = 'none';
                                    currentTranslate = -(itemWidth * index);
                                    track.style.transform = `translateX(${currentTranslate}px)`;
                                    track.offsetHeight;
                                } else if(index < clonesPerSide){
                                    // moved into left clones, shift forward by realCount
                                    index = index + realCount;
                                    track.style.transition = 'none';
                                    currentTranslate = -(itemWidth * index);
                                    track.style.transform = `translateX(${currentTranslate}px)`;
                                    track.offsetHeight;
                                }
                            }
                        }, 420);
                    }
                }

                function correctWrapDuringInteraction(){
                    // called during pointermove/wheel to keep position within the central real block
                    if(realCount <= 0) return;
                    const approx = Math.round(-currentTranslate / itemWidth);
                    if(approx < clonesPerSide){
                        // moved into left clones -> jump right by realCount
                        currentTranslate -= realCount * itemWidth;
                        index += realCount;
                        track.style.transition = 'none';
                        track.style.transform = `translateX(${currentTranslate}px)`;
                        // update startTranslate so dragging feels continuous
                        startTranslate = currentTranslate;
                    } else if(approx >= clonesPerSide + realCount){
                        // moved into right clones -> jump left by realCount
                        currentTranslate += realCount * itemWidth;
                        index -= realCount;
                        track.style.transition = 'none';
                        track.style.transform = `translateX(${currentTranslate}px)`;
                        startTranslate = currentTranslate;
                    }
                }

                // initialize after images load so sizes are correct
                window.addEventListener('load', ()=>{ update(false); });
                // also on DOM ready
                document.addEventListener('DOMContentLoaded', ()=>{ update(false); });
                window.addEventListener('resize', ()=>{ update(); });

                // Auto-rotate within valid index range
                const autoInterval = 4000;
                let auto = null;
                function startAuto(){
                    stopAuto();
                    // start a simple incrementing auto-rotation; wrap correction is handled in update()
                    auto = setInterval(()=>{ index = index + 1; update(); }, autoInterval);
                }
                function stopAuto(){ if(auto) { clearInterval(auto); auto = null; } }
                startAuto();

                // Pause on hover/focus
                track.addEventListener('pointerenter', ()=>{ stopAuto(); });
                track.addEventListener('pointerleave', ()=>{ startAuto(); });

                // Wheel to scroll horizontally (mouse wheel / touchpad horizontal swipe)
                let wheelTimeout = null;
                track.addEventListener('wheel', function(e){
                    // allow preventing vertical page scroll while over carousel
                    e.preventDefault();
                    if(isDown) return; // ignore while dragging

                    stopAuto();

                    // Normalize delta (lines -> pixels)
                    let delta = e.deltaY || e.deltaX || 0;
                    if(e.deltaMode === 1) delta *= 16; // DOM_DELTA_LINE

                    // Invert sign so wheel-down moves carousel to next items
                    const speed = 1.2;
                    currentTranslate -= delta * speed;

                    // Apply transform immediately
                    track.style.transition = 'none';
                    track.style.transform = `translateX(${currentTranslate}px)`;

                    // keep seamless infinite scroll during wheel interaction
                    correctWrapDuringInteraction();

                    // Debounce snapping to nearest slide after wheel ends
                    clearTimeout(wheelTimeout);
                    wheelTimeout = setTimeout(()=>{
                        snapToNearest();
                        startAuto();
                    }, 120);
                }, {passive:false});

                // Dragging / swiping (pointer events)
                let isDown = false;
                let startX = 0;
                let startTranslate = 0;

                track.style.touchAction = 'pan-y';

                function onPointerDown(e){
                    isDown = true;
                    startX = e.clientX;
                    startTranslate = currentTranslate;
                    try{ track.setPointerCapture(e.pointerId); }catch(_){}
                    track.style.transition = 'none';
                    stopAuto();
                }

                function onPointerMove(e){
                    if(!isDown) return;
                    const dx = e.clientX - startX;
                    currentTranslate = startTranslate + dx;
                    track.style.transform = `translateX(${currentTranslate}px)`;
                    // keep seamless infinite scroll during interaction
                    correctWrapDuringInteraction();
                }

                function snapToNearest(){
                    const approx = Math.round(-currentTranslate / itemWidth);
                    const maxIdx = Math.max(0, track.children.length - 1);
                    index = Math.max(0, Math.min(maxIdx, approx));
                    update();
                }

                function onPointerUp(e){
                    if(!isDown) return;
                    isDown = false;
                    try{ track.releasePointerCapture(e.pointerId); }catch(_){}
                    snapToNearest();
                    startAuto();
                }

                // attach listeners to track and its items (to ensure capture when pressing on children)
                track.addEventListener('pointerdown', onPointerDown);
                track.addEventListener('pointermove', onPointerMove);
                track.addEventListener('pointerup', onPointerUp);
                track.addEventListener('pointercancel', onPointerUp);

                // also attach to children to improve responsiveness
                function attachToItems(){
                    items.forEach(it=>{
                        it.style.touchAction = 'none';
                        it.addEventListener('pointerdown', onPointerDown);
                        it.addEventListener('pointermove', onPointerMove);
                        it.addEventListener('pointerup', onPointerUp);
                        it.addEventListener('pointercancel', onPointerUp);
                    });
                }
                attachToItems();

                // re-attach if DOM changes
                const mo = new MutationObserver(()=>{ recalc(); attachToItems(); update(false); startAuto(); });
                mo.observe(track, { childList:true });

                // initial call
                requestAnimationFrame(()=>{ update(false); startAuto(); });
            })();

            // Instagram Feed Integration
            (function(){
                const feedContainer = document.getElementById('instagram-feed');
                if(!feedContainer) return;
                // If server rendered posts are present, skip client fetch
                if(feedContainer.children.length > 0) return;

                // Client-side fetch is a fallback only. Leave accessToken empty to avoid exposing secrets.
                const accessToken = '';

                async function loadInstagramFeed() {
                    try {
                        const response = await fetch(`https://graph.instagram.com/me/media?fields=id,caption,media_type,media_url,permalink,thumbnail_url&access_token=${accessToken}`);
                        const data = await response.json();
                        
                        if(data.data && Array.isArray(data.data)) {
                            // Take only the first 6 posts
                            const posts = data.data.slice(0, 6);
                            
                            feedContainer.innerHTML = posts.map(post => `
                                <a href="${post.permalink}" target="_blank" class="instagram-post">
                                    <img src="${post.media_type === 'VIDEO' ? post.thumbnail_url : post.media_url}" 
                                         alt="${post.caption ? post.caption.slice(0, 50) + '...' : 'Instagram post'}"
                                         loading="lazy">
                                </a>
                            `).join('');
                        }
                    } catch(error) {
                        console.error('Error loading Instagram feed:', error);
                        feedContainer.innerHTML = `
                            <div style="text-align:center;padding:20px;color:var(--muted-soft)">
                                Error al cargar las publicaciones de Instagram.<br>
                                Por favor, inténtalo de nuevo más tarde.
                            </div>
                        `;
                    }
                }

                // Load the feed (only if an access token is provided)
                if(accessToken) loadInstagramFeed();

                // Refresh every 5 minutes
                setInterval(loadInstagramFeed, 5 * 60 * 1000);
            })();
        </script>
    </body>
</html>